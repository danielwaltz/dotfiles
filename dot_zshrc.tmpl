{{- if eq .chezmoi.os "darwin" }}
# Kiro CLI pre block. Keep at the top of this file.
[[ -f "${HOME}/Library/Application Support/kiro-cli/shell/zshrc.pre.zsh" ]] && builtin source "${HOME}/Library/Application Support/kiro-cli/shell/zshrc.pre.zsh"
{{- end }}

### options
zstyle :omz:update mode disabled
zstyle :omz:plugins:keychain agents gpg,ssh
zstyle :omz:plugins:keychain options --quiet

### antidote
source ~/.local/share/antidote/antidote.zsh
antidote load

### path
export PATH="$HOME/.local/bin:$PATH"

### startup
if [[ -o interactive ]]; then
  fastfetch
fi

### aliases
function auth() {
  if ! pass-cli test >/dev/null 2>&1; then
    pass-cli login
  fi

  if ! ssh-add -l >/dev/null 2>&1; then
    if [ ! -d "$HOME/.ssh" ]; then
      echo "SSH directory not found. Creating..."
      mkdir -p "$HOME/.ssh"
      chmod 700 "$HOME/.ssh"
    fi

    # Personal SSH
    personal_ssh_key_file="$(pass-cli item view "pass://Personal/Personal SSH Key/File")"
    if [ -z "$personal_ssh_key_file" ]; then
      echo "Personal SSH Key file name not found in password store."
      return 1
    fi
    personal_ssh_key_path="$HOME/.ssh/$personal_ssh_key_file"
    if [ ! -f "$personal_ssh_key_path" ]; then
      echo "Personal SSH Key not found locally. Importing..."
      pass-cli item view "pass://Personal/Personal SSH Key/public_key" > "$personal_ssh_key_path.pub"
      pass-cli item view "pass://Personal/Personal SSH Key/private_key" > "$personal_ssh_key_path"
      chmod 600 "$personal_ssh_key_path"
      echo "Personal SSH Key added."
    fi
    SSH_ASKPASS=~/.ssh/ssh-askpass-stdout.sh SSH_ASKPASS_REQUIRE=force ssh-add -q "$personal_ssh_key_path" <<< "$(pass-cli item view "pass://Personal/Personal SSH Key/Passphrase")"

    {{- if eq .chezmoi.os "darwin" }}
    # Moser SSH
    moser_ssh_key_file="$(pass-cli item view "pass://Moser Consulting/Moser SSH Key/File")"
    if [ -z "$moser_ssh_key_file" ]; then
      echo "Moser SSH Key file name not found in password store."
      return 1
    fi
    moser_ssh_key_path="$HOME/.ssh/$moser_ssh_key_file"
    if [ ! -f "$moser_ssh_key_path" ]; then
      echo "Moser SSH Key not found locally. Importing..."
      pass-cli item view "pass://Moser Consulting/Moser SSH Key/public_key" > "$moser_ssh_key_path.pub"
      pass-cli item view "pass://Moser Consulting/Moser SSH Key/private_key" > "$moser_ssh_key_path"
      chmod 600 "$moser_ssh_key_path"
      echo "Moser SSH Key added."
    fi
    SSH_ASKPASS=~/.ssh/ssh-askpass-stdout.sh SSH_ASKPASS_REQUIRE=force ssh-add -q "$moser_ssh_key_path" <<< "$(pass-cli item view "pass://Moser Consulting/Moser SSH Key/Passphrase")"
    {{- end }}
  fi

  # Personal GPG
  personal_gpg_key_id="$(pass-cli item view "pass://Personal/Personal GPG Key/ID")"
  if [ -z "$personal_gpg_key_id" ]; then
    echo "Personal GPG Key ID not found in password store."
    return 1
  fi
  if ! gpg --list-keys "$personal_gpg_key_id" >/dev/null 2>&1; then
    echo "Personal GPG Key not found locally. Importing..."
    pass-cli item view "pass://Personal/Personal GPG Key/public_key" | gpg --import
    pass-cli item view "pass://Personal/Personal GPG Key/private_key" | gpg --import
    printf '5\ny\n' | gpg --command-fd 0 --edit-key "$personal_gpg_key_id" trust quit
    echo "Personal GPG Key added."
  fi

  {{- if eq .chezmoi.hostname "themacbook" }}
  # Moser GPG
  moser_gpg_key_id="$(pass-cli item view "pass://Moser Consulting/Moser GPG Key/ID")"
  if [ -z "$moser_gpg_key_id" ]; then
    echo "Moser GPG Key ID not found in password store."
    return 1
  fi
  if ! gpg --list-keys "$moser_gpg_key_id" >/dev/null 2>&1; then
    echo "Moser GPG Key not found locally. Importing..."
    pass-cli item view "pass://Moser Consulting/Moser GPG Key/public_key" | gpg --import
    pass-cli item view "pass://Moser Consulting/Moser GPG Key/private_key" | gpg --import
    printf '5\ny\n' | gpg --command-fd 0 --edit-key "$moser_gpg_key_id" trust quit
    echo "Moser GPG Key added."
  fi
  {{- end }}
}
function update() {
  echo '\e[32m\ue5fc chezmoi'
  chezmoi update --apply

  echo '\e[32m\ue795 antidote'
  antidote update

  if command -v apt &> /dev/null; then
    echo '\e[32m\ue77d apt'
    sudo apt update && sudo apt upgrade
  fi

  if command -v dnf &> /dev/null; then
    echo '\e[32m\ue7d9 dnf'
    sudo dnf upgrade
  fi

  if command -v pacman &> /dev/null; then
    if command -v paru &> /dev/null; then
      echo '\e[32m\ue732 paru'
      paru -Syu
    else
      echo '\e[32m\ue732 pacman'
      sudo pacman -Syu
    fi
  fi

  if command -v flatpak &> /dev/null; then
    echo '\e[32m\uf1b2 flatpak'
    flatpak update -y
  fi

  if command -v mas &> /dev/null; then
    echo '\e[32m\ue711 mas'
    mas upgrade
  fi

  echo '\e[32m\uf0fc brew'
  brew update && brew upgrade && brew upgrade --cask

  echo '\e[32m\uf1b2 mise'
  mise upgrade
}
function cleanup() {
  if command -v apt &> /dev/null; then
    echo '\e[32m\ue77d apt'
    sudo apt autoremove --purge
  fi

  if command -v dnf &> /dev/null; then
    echo '\e[32m\ue7d9 dnf'
    sudo dnf autoremove
  fi

  if command -v pacman &> /dev/null; then
    if command -v paru &> /dev/null; then
      echo '\e[32m\ue732 paru'
      paru -Rsn $(paru -Qtdq)
    else
      echo '\e[32m\uf303 pacman'
      sudo pacman -Rns $(pacman -Qtdq)
    fi

    paccache -r
  fi

  if command -v flatpak &> /dev/null; then
    echo '\e[32m\uf1b2 flatpak'
    flatpak uninstall --unused -y
  fi

  if command -v docker &> /dev/null; then
    echo '\e[32m\ue7b0 docker'
    docker system prune -f
  fi

  echo '\e[32m\uf0fc brew'
  brew cleanup

  echo '\e[32m\uf1b2 mise'
  mise prune
}
alias bump='bunx taze@latest -rwiI'
alias bumpall='bunx taze@latest major -rwiu && git commit -am "chore: update deps"'
alias c='clear'
alias dotfiles='chezmoi edit'
alias ls='eza -al --color=always --group-directories-first --icons=always' # preferred listing
alias la='eza -a --color=always --group-directories-first --icons=always'  # all files and dirs
alias ll='eza -l --color=always --group-directories-first --icons=always'  # long format
alias lt='eza -aT --color=always --group-directories-first --icons=always' # tree listing
alias l.="eza -a | grep -e '^\.'"                                          # show only dotfiles
alias lint='bunx oxlint@latest --tsconfig tsconfig.json --import-plugin --jsdoc-plugin --vitest-plugin --react-perf-plugin --promise-plugin --node-plugin'
alias fmt='bunx oxfmt@latest'
alias pretty='bunx prettier@latest --write --ignore-unknown -- "**/*" "!**/package-lock.json" "!**/yarn.lock" "!**/pnpm-lock.yaml" "!**/bun.lock" "!**/deno.lock" "!**/dist/**" "!**/.output/**" "!**/build/**" "!**/out/**"'
alias rmlock='rm -rf **/node_modules(N) **/package-lock.json(N) **/yarn.lock(N) **/pnpm-lock.yaml(N) **/bun.lock(N) **/bun.lockb(N) **/deno.lock(N)'
alias rmdist='rm -rf **/dist(N) **/.output(N) **/build(N) **/out(N)'
alias src='chezmoi apply && source ~/.zshrc'
{{- if eq .chezmoi.os "darwin" }}
alias spacer='defaults write com.apple.dock persistent-apps -array-add '"'"'{tile-type=\"spacer-tile\";}'"'"' && killall Dock'
alias spacermini='defaults write com.apple.dock persistent-apps -array-add '"'"'{tile-type=\"small-spacer-tile\";}'"'"' && killall Dock'
alias dsdestroy='find . -name '"'"'*.DS_Store'"'"' -type f -ls -delete'
{{- end }}

### init
# TODO: use pass-cli ssh-agent integration when matured
# if command -v pass-cli &> /dev/null; then
#   pass-cli test >/dev/null 2>&1 || return
#   eval "$(keychain --eval --quiet --stop all)"
#   ps aux | grep pass-cli | grep -v "grep" >/dev/null || pass-cli ssh-agent start >/dev/null 2>&1 &
#   export SSH_AUTH_SOCK="$HOME/.ssh/proton-pass-agent.sock"
# fi
export EDITOR="vim"
export VISUAL=$EDITOR
export OS="`uname`"
export PROMPT_COMMAND="history -a; $PROMPT_COMMAND"
[[ -n $GHOSTTY_RESOURCES_DIR ]] && source "$GHOSTTY_RESOURCES_DIR"/shell-integration/zsh/ghostty-integration
[[ "$TERM_PROGRAM" == "vscode" ]] && . "$(code --locate-shell-integration-path zsh)"

{{- if eq .chezmoi.os "darwin" }}
# Kiro CLI post block. Keep at the bottom of this file.
[[ -f "${HOME}/Library/Application Support/kiro-cli/shell/zshrc.post.zsh" ]] && builtin source "${HOME}/Library/Application Support/kiro-cli/shell/zshrc.post.zsh"
{{- end }}
